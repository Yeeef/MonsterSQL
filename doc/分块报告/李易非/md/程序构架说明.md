# ç¨‹åºæ¡†æ¶è¯´æ˜ ğŸ‘¹

> By ææ˜“é 3160105705
>
> åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘è´Ÿè´£ç¨‹åºæ¡†æ¶è®¾è®¡ï¼Œå®ç° API, CatalogManager, BufferManager, RecordManager

## ä¸€ã€è®¾è®¡ç®€ä»‹

â€‹	æœ¬æ¬¡å·¥ç¨‹ä¸­éœ€è¦å®ç° Interpreterï¼ŒAPIï¼ŒRecord Managerï¼ŒCatalog Managerï¼ŒBuffer Managerï¼ŒIndex Managerï¼›

- Interpreter

- API æ˜¯ç¨‹åºçš„æ ¸å¿ƒï¼Œå®ƒç›´æ¥æ¥æ”¶ Interpreter æä¾›çš„æ•°æ®ä¿¡æ¯ï¼Œè°ƒç”¨å„ä¸ª Manager æ¥å®Œæˆæ•°æ®åº“çš„æ’å…¥ / åˆ é™¤ / æ›´æ–°ï¼›

- Record Manager ç®¡ç†å„ä¸ªè¡¨çš„å…·ä½“è®°å½•ï¼›

- Catalog Manager ç®¡ç†æ•°æ®åº“çš„å…ƒä¿¡æ¯ï¼›

- Buffer Manager ç®¡ç†æ•°æ®åº“ä¸æ–‡ä»¶å±‚çš„äº¤äº’ï¼›

- Index Manager ç®¡ç†æ•°æ®åº“ä¸­çš„ç´¢å¼• ( B+ æ ‘ ) ï¼›

  å„ä¸ª Manager ç›¸äº’åˆä½œï¼Œå…±åŒç»´æŠ¤æ•°æ®åº“çš„æ•°æ®ï¼›

  â€‹



## äºŒã€é‡è¦ç±»ç®€ä»‹

â€‹	åœ¨å·¥ç¨‹ä¸­ï¼Œå„ä¸ª Manager çš„å…·ä½“ä»‹ç»å¯è¯¦è§å„ Manager éƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸»è¦ä»‹ç»ä¸€äº›å…¶å®ƒçš„é‡è¦ç±»ï¼›

#### 3.1 MiniSQL 

â€‹	å·¥ç¨‹ä¸­é¢ä¸´çš„ä¸€å¤§éš¾é¢˜æ˜¯ Manager ä¹‹é—´çš„äº’ç›¸è°ƒç”¨ï¼Œä»¥åŠ API å¯¹äºå„ä¸ª Manager çš„è°ƒç”¨ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯å®ç°ä¸€ä¸ª MiniSQL ç±»ï¼Œå®ƒæ‹¥æœ‰å„ä¸ª Manager çš„é™æ€æˆå‘˜å˜é‡ï¼Œè¿™æ ·åšçš„ç†ç”±å¦‚ä¸‹ï¼š

- å„ä¸ª Manager å¹¶é API çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå¹¶é Interpreter çš„æˆå‘˜å˜é‡ï¼Œè¦åœ¨ä¸åŒå‡½æ•°å†…éƒ¨è°ƒç”¨ä¸åŒ Manager æ˜¯ä¸€ä»¶æ£˜æ‰‹çš„äº‹æƒ…ï¼›

- æ•´ä¸ªç¨‹åºå…±äº«ä¸€ä»½ Managerï¼Œä¸€å®šç¨‹åº¦ä¸Šåæ˜ äº† **å…¨å±€æ€§**

  å…·ä½“ç±»å®šä¹‰å¦‚ä¸‹ï¼š

  ``` c++
  class MiniSQL
  {
      private:
      static API & api;
      static CatalogManager & catalog_manager;
      static RecordManager & record_manager;
      static BufferManager & buffer_manager;
      static IndexManager & index_manager;
      

      public:
      static API & get_api();
      static CatalogManager & get_catalog_manager();
      static RecordManager & get_record_manager();
      static BufferManager & get_buffer_manager();
      static IndexManager & get_index_manager();
     
  };

  ```

- ä½¿ç”¨èŒƒä¾‹

  -  `API & api = MiniSQL::get_api()` ï¼ŒInterpreter å¯ä»¥æ­£å¸¸è°ƒç”¨ API ,å®ç°å¯¹åº”åŠŸèƒ½ï¼›
  -  `CatalogManager & catalogmanager= MiniSQL::get_catalog_manager()`, APIæˆ–è€…å…¶å®ƒéœ€è¦å…ƒæ•°æ®çš„ Manager å¯ä»¥è½»æ¾è°ƒç”¨ Catalog Managerï¼Œæå–éœ€è¦ä¿¡æ¯ï¼›






#### 3.2 Method

â€‹	å·¥ç¨‹ä¸­é¢ä¸´çš„ä¸€å¤§éš¾é¢˜æ˜¯å¯¹äºæ•°æ®æ–‡ä»¶çš„è¯»å†™ï¼Œæ•°æ®åº“æ–‡ä»¶éƒ½æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸åŒçš„è§£é‡Šæ–¹å¼å†³å®šäº†ä¸åŒçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å®ç°äº† `Method` ç±»ï¼Œå…¶ä¸­åŒ…å«æ•´ä¸ªæ•°æ®åº“éƒ½éœ€è¦çš„å‡½æ•°ï¼›

å…·ä½“ç±»å®šä¹‰å¦‚ä¸‹ï¼š( ç®€åŒ–ç‰ˆ )

``` c++
class Method
{
    public:
    //è¿™ä¸ªå‡½æ•°å†…éƒ¨æœ‰new
   
    static int rawdata2int(const char * rawdata);
    static float rawdata2float(const char * rawdata);
    static void rawdata2string(const char * rawdata, int length, string & out_str);
    static void string2rawdata(const string & str, const int type, char * rawdata);
    static bool isSatisfyConditon(const char * rawdata, const int cond, const string & operand, const int type);
	static const int getLengthFromType(int type);
};
```

***å…·ä½“è¯´æ˜***

- `rawdata2int` å°†ä¸€æ®µ rawdata ç¿»è¯‘ä¸ºæ•´å‹å˜é‡ï¼›

- `rawdata2float` å°†ä¸€æ®µ rawdata ç¿»è¯‘ä¸º float å‹å˜é‡ï¼›

- `rawdata2string` å°†ä¸€æ®µ rawdata ç¿»è¯‘ä¸º string;

- `string2rawdata ` å°† string ç¿»è¯‘ä¸º rawdata;

- `isSatisfyCondition`ç»™å®š rawdata ä¸å®ƒçš„ç±»å‹ï¼Œåˆ¤æ–­è¿™æ®µrecordæ˜¯å¦ç¬¦åˆå¯¹åº”çš„æ¡ä»¶ä¸æ“ä½œæ•°ï¼›

- `getLengthFromType(type)` 

  - ä»‹ç»è¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œæœ‰å¿…è¦ä»‹ç»å·¥ç¨‹ä¸­å¯¹æ•°æ®ç±»å‹çš„å¤„ç†ï¼Œåˆ©ç”¨å®å®šä¹‰
    - `#define TYPE_INT 256`
    - `#define TYPE_FLOAT 257`
    - `#define TYPE_CHAR 255`
    - `#define MIN_TYPE_LENGTH 4`
  - å› ä¸º varchar ç±»å‹å˜é‡æœ€é•¿ä¸º 255 bytesï¼Œå°äº255çš„ç±»å‹ä¸€å®šæ˜¯ varchar ç±»å‹å˜é‡ï¼Œæ­¤æ—¶å®ƒçš„ data_type å°±æ˜¯å®ƒçš„å®é™…é•¿åº¦ï¼›
  - å› ä¸º free_list çš„ç»´æŠ¤è‡³å°‘éœ€è¦ 4 bytesæ¥æ ‡è®°ä¸‹ä¸€æ¡åˆ é™¤è®°å½•çš„ä½ç½®ï¼Œæ‰€ä»¥æœ€çŸ­çš„ç±»å‹é•¿åº¦ä¸º4ï¼Œvarchar(j) j < 4 å‡è¢«çœ‹ä½œ varchar(4)
  - Int / float æ­£å¸¸ç¿»è¯‘å³å¯ï¼›

  ``` c++
  switch(type)
      case TYPE_INT : é•¿åº¦ = 4;
      case TYPE_FLOAT : é•¿åº¦ = 4;
  	default : 
  		if(type < 4)
              é•¿åº¦ = 4;
  		else
              é•¿åº¦ = type;
  ```

  â€‹


#### 3.3 Attribute

â€‹	Attribute çš„ä¿¡æ¯å¯¹äºæ•°æ®åº“è‡³å…³é‡è¦ï¼ŒAttribute ç±»ä¸­å«æœ‰ å±æ€§åç§°ï¼Œå±æ€§ç±»å‹ï¼Œå±æ€§é•¿åº¦ï¼Œæ˜¯å¦ Primary, æ˜¯å¦ Uniqueï¼›

``` c++
class Attribute
{
    string name;
    short type;
    int length;
    bool isPrimary;
    bool isUnique;

};
```



### 3.4 Table

â€‹	Table ç±»å­˜å‚¨åœ¨ CatalogManger ä¸­ï¼Œé€šè¿‡ CatalogManger çš„ get_table å‡½æ•°ï¼Œæ•°æ®åº“å¯ä»¥è·å¾—ä¸€ä¸ªè¡¨çš„æ‰€æœ‰ä¿¡æ¯ï¼›

``` c++
class Table
{
    string table_name;
    int record_length; 							  // è®°å½•çš„é€»è¾‘é•¿åº¦
    unordered_map <string, Attribute> Name2Attri; //åå­—åˆ°å±æ€§çš„hash
    unordered_map <string, int > Name2Pos; 	//å±æ€§åå­—åˆ°å±æ€§ä½ç½®çš„hash
};
```



### 3.5 Block 

â€‹	Block ç±»ä¸­åŒ…å«æ–‡ä»¶åï¼ŒBlock IDï¼ŒBlockå†…å®¹ä¿¡æ¯ï¼›å®ƒç”± BufferManager è¿›è¡Œé›†ä¸­ç®¡ç†ï¼›

``` c++
class Block
{
    string filename;			// Block æ‰€åœ¨çš„æ–‡ä»¶
    int block_id;				// Block åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®
    bool dirty;					// Block æ˜¯å¦è¢«ä¿®æ”¹è¿‡
    char * content;				// Block ä¸­çš„çœŸå®å†…å®¹

};
```



















## ä¸‰ã€æ–‡ä»¶å­˜å‚¨æ–¹å¼

### 3.1 è®¾è®¡ç®€ä»‹

â€‹	æœ¬æ¬¡å®éªŒä¸­ï¼Œæœ‰3ç§ç±»å‹çš„æ–‡ä»¶

1. è¡¨çš„ metadataï¼›

2. ç´¢å¼•çš„ metadata;

3. æ•°æ®æ–‡ä»¶ï¼›

4. ç´¢å¼•æ–‡ä»¶ï¼›

   å‰ä¸‰ç§æ–‡ä»¶æˆ‘ä»¬è¿›è¡Œäº†**åŒè´¨åŒ–å¤„ç†**ï¼Œå¯ä»¥ç”¨ç›¸åŒçš„å¤„ç†æ–¹å¼æ¥è¯»å¯¹åº”æ•°æ®ï¼Œç¬¬å››ç§æ–‡ä»¶å› ä¸º B+ æ ‘çš„ç‰¹æ€§ï¼Œé‡‡å–äº†ä¸åŒçš„å­˜å‚¨æ–¹å¼ï¼›

   â€‹

### 3.2 å…·ä½“å®ç°

### 3.2.1 æ•°æ®æ–‡ä»¶åŸºæœ¬çº¦å®š



#### 3.2.1.1 ç‰©ç†å­˜å‚¨è¯´æ˜

- é‡‡ç”¨**å®šé•¿è®°å½•**æ–¹æ³•ï¼Œ`varchar(n)` å°†åœ¨æ•°æ®æ–‡ä»¶ä¸­åˆ†é… n ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œä¸ä¼šå› ä¸ºå…·ä½“è®°å½•é•¿åº¦çš„å˜åŒ–è€Œå˜åŒ–ï¼›
- é‡‡ç”¨ **Heap File** æ–¹æ³•ï¼Œå³æ–‡ä»¶å†…éƒ¨ record æ²¡æœ‰å›ºå®šçš„å­˜å‚¨é¡ºåºï¼Œé€šè¿‡ **free list** æ¥æ ‡è®°æ‰€æœ‰è¢«åˆ é™¤çš„è®°å½•ã€‚free list header åœ¨æ–‡ä»¶ä¸­å æ®4ä½ ( int )ï¼Œè‹¥ä¸º -1 åˆ™è¯´æ˜åˆ°äº† free list å°¾éƒ¨ï¼Œè‹¥ä¸ä¸º1ï¼Œåˆ™ä»£è¡¨ä¸‹ä¸€æ¡æ— æ•ˆ record åœ¨æ–‡ä»¶ä¸­çš„**ç»å¯¹åœ°å€**ã€‚å…¶ä½™è¢«åˆ é™¤è®°å½•çš„å‰å››ä½ä¸ä¸Šè¿°é€»è¾‘ç›¸åŒï¼Œè‹¥ä¸º -1 åˆ™è¯´æ˜åˆ°äº† free list å°¾éƒ¨ï¼Œè‹¥ä¸ä¸º1ï¼Œåˆ™ä»£è¡¨ä¸‹ä¸€æ¡æ— æ•ˆ record åœ¨æ–‡ä»¶ä¸­çš„**ç»å¯¹åœ°å€**ï¼›
- æ¯ä¸€æ¡æ•°æ®åæ–°å¢ä¸€ä¸ª **æœ‰æ•ˆä½** ï¼Œåœ¨éå†æ–‡ä»¶è¿‡ç¨‹ä¸­ï¼Œä»…ä»…é€šè¿‡ **free list** æ¥åˆ¤æ–­ä¸€ä¸ª record æ˜¯å¦è¢«åˆ é™¤éå¸¸è€—æ—¶ï¼Œæœ€ç»ˆæˆ‘ä»¬å†³å®š **ç©ºé—´æ¢æ—¶é—´**ï¼Œ åœ¨æ¯ä¸€æ¡è®°å½•åéƒ½æ·»åŠ ä¸€ä¸ªæœ‰æ•ˆä½ï¼Œè‹¥ä¸º1åˆ™è¡¨ç¤ºæœ‰æ•ˆè®°å½•ï¼Œè‹¥ä¸º0åˆ™è¡¨ç¤ºæ— æ•ˆè®°å½•ï¼›
- è®°å½• **ä¸ä¼šè·¨å—å­˜å‚¨** ï¼Œåœ¨ä¸€ä¸ª Block ä¸è¶³ä»¥å®¹çº³ä¸€æ¡è®°å½•æ—¶ï¼Œç›´æ¥å‰å¾€ä¸‹ä¸€ä¸ª Blockï¼›



#### 3.2.1.2 é€»è¾‘å­˜å‚¨è¯´æ˜

- æ¯ä¸ªæ•°æ®æ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„ metadataï¼Œå­˜å‚¨åœ¨æ‰€æœ‰æ–‡ä»¶çš„ **ç¬¬ä¸€ä¸ª Block** ä¸­ï¼ŒmetadataåŒ…å« 
  - Record Length ( ç‰©ç†é•¿åº¦ï¼ŒåŒ…å«äº†æœ‰æ•ˆä½ )
  - free list headerï¼Œfree list é“¾è¡¨å¤´ï¼ŒæŒ‡å‘ä¸€ä¸ªè¢«åˆ é™¤çš„è®°å½•ï¼›
  - Record Countï¼Œä»£è¡¨æ–‡ä»¶ä¸­è®°å½•æ€»æ•°ï¼Œæ³¨æ„è¿™é‡ŒåŒ…å«æ— æ•ˆè®°å½•ã€‚è¿™æ˜¯ä¸ºäº†ç¡®è®¤æ–‡ä»¶ **EOF** çš„å…·ä½“ä½ç½®ï¼›
- å…¶ä½™çš„ Block æ­£å¸¸å­˜å‚¨æ•°æ®ï¼Œè‹¥ä¸ºæ— æ•ˆè®°å½•ï¼Œåˆ™å‰å››ä½æŒ‡å‘ free list ä¸‹ä¸€æ¡æ— æ•ˆè®°å½•ï¼›è‹¥ä¸ºæœ‰æ•ˆè®°å½•ï¼Œåˆ™æ˜¯ä¸€ä¸ª record çš„æ­£å¸¸å­˜å‚¨å•å…ƒï¼›



#### 3.2.1.3 æ³¨æ„äº‹é¡¹

- é€»è¾‘ Record Length ä¸ºç‰©ç† Record Length å‡1ï¼›
- å› ä¸ºè¦ç»´æŠ¤ä¸€ä¸ª free listï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸€ä¸ªæŒ‡é’ˆéƒ½åˆ†é…äº†å››ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œæ‰€ä»¥å¯¹äº varchar( j ) ( j < 4 ) ç±»å‹ï¼Œæˆ‘ä»¬éƒ½æŒ‰ç…§ varchar ( 4 ) è¿›è¡Œå¤„ç†ï¼›
- Record Countï¼Œä»£è¡¨æ–‡ä»¶ä¸­è®°å½•æ€»æ•°ï¼Œæ³¨æ„è¿™é‡ŒåŒ…å«æ— æ•ˆè®°å½•ã€‚è¿™æ˜¯ä¸ºäº†ç¡®è®¤æ–‡ä»¶ **EOF** çš„å…·ä½“ä½ç½®ï¼›





### 3.2.2 å…·ä½“æ•°æ®æ–‡ä»¶å­˜å‚¨å†…å®¹

#### 3.2.2.1 Table Meta å­˜å‚¨è¯´æ˜

â€‹	Table Meta å­˜å‚¨åœ¨ç‰¹å®šæ–‡ä»¶å¤¹   `TableMeta/` ä¸­ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæä¾›æ‰€æœ‰ Table åå­—çš„ `TableMeta/tables` æ–‡ä»¶ï¼Œä»¥åŠå„ä¸ª Table å¯¹åº”çš„ Meta Data æ–‡ä»¶ `TableMeta/Table `

- `TableMeta/tables` å­˜å‚¨æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨å ( 32 bytes ) ï¼›

- `TableMeta/Table` å­˜å‚¨ç‰¹å®š table çš„å±æ€§ä¿¡æ¯ï¼Œæ–‡ä»¶ä¸­çš„ä¸€æ¡è®°å½•å­˜å‚¨å±æ€§å ( 32 bytes ) ã€æ•°æ®ç±»å‹ ( 2 bytes ) ã€æ˜¯å¦ä¸»é”® ( 1 byte ) ã€æ˜¯å¦å”¯ä¸€ ( 1 byte ) ï¼›

  æŠŠ Table Meta åˆåˆ†æˆ tables ä¸ ç‰¹å®š table æ˜¯ä¸ºäº†ä¿æŒåŒä¸€ä¸ªæ–‡ä»¶çš„ **record length ä¸€è‡´**ï¼Œå› ä¸ºä¸åŒè¡¨çš„å±æ€§ä¸ªæ•°æ˜¯ä¸åŒçš„ï¼Œå¦‚æœå­˜å‚¨åœ¨ä¸€èµ·ï¼Œå¾ˆéš¾åœ¨ä¸æµªè´¹ç©ºé—´çš„å‰æä¸‹ä¿æŒè®°å½•é•¿åº¦çš„ä¸€è‡´æ€§ï¼›

  â€‹

#### 3.2.2.2 Index Meta å­˜å‚¨è¯´æ˜

â€‹	Index Meta å­˜å‚¨åœ¨ç‰¹å®šæ–‡ä»¶å¤¹ `IndexMeta/` ä¸­ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæä¾›æ‰€æœ‰ Index ä¿¡æ¯çš„ `IndexMeta/indices`æ–‡ä»¶ã€‚

- `IndexMeta/indices` å­˜å‚¨ ç´¢å¼•å ( 64 bytes ) ã€è¡¨å ( 32 bytes )ã€å±æ€§å ( 32 bytes )ï¼› 

ğŸ‘‡æ˜¯ä¸€ä¸ªä¾‹å­

```
+--- TableMeta
|		|--- tables
|		|--- book
|		|--- student
|
+--- IndexMeta
		|--- indices
```



#### 3.2.2.3 å…·ä½“è®°å½•å­˜å‚¨è¯´æ˜

â€‹	å…·ä½“è®°å½•æ–‡ä»¶å­˜å‚¨åœ¨ç‰¹å®šæ–‡ä»¶å¤¹ `data/` ä¸‹ï¼Œæ¯ä¸€å¼ è¡¨å æ®ä¸€ä¸ªæ–‡ä»¶ï¼Œå­˜å‚¨è¡¨ä¸­çœŸå®çš„è®°å½•ã€‚

ğŸ‘‡æ˜¯ä¸€ä¸ªä¾‹å­

```
+--- data
	   |--- book
	   |--- student
```


